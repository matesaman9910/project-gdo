<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SGC Listener</title>
  <style>
    /* Stargate theme (Orbitron font, neon cyan accents) */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron&display=swap');
    body { margin:0; background: #001419; color: #8df9ff; font-family:'Orbitron', monospace; display:flex; flex-direction:column; align-items:center; padding:2rem; user-select:none; }
    h1 { font-size:3rem; text-shadow:0 0 8px #00ffff; margin-bottom:1rem; }
    select, button { background:#002933; color:#00ffff; border:1px solid #00ffff; padding:.5rem 1rem; font-family:'Orbitron'; cursor:pointer; margin:0.5rem; }
    #log { background:rgba(0,20,30,0.8); border:2px solid #00ffff; border-radius:8px; width:90%; max-width:500px; min-height:150px; padding:1rem; white-space:pre-wrap; box-shadow:0 0 10px #00ffff66; margin-top:1rem; }
    #incoming { font-size:2rem; font-weight:bold; color:#00ffff; animation:blink 1s infinite; margin:1rem 0; display:none; }
    #waiting { font-style:italic; opacity:.6; }
    @keyframes blink { 0%,50%,100% {opacity:1;} 25%,75% {opacity:0.2;} }
    #mainInterface { display:none; flex-direction:column; align-items:center; }
    #authSection { margin-top:2rem; }
  </style>
</head>
<body>
  <h1>SGC COMMAND TERMINAL</h1>

  <!-- Sign-In -->
  <div id="authSection">
    <button id="signInBtn">Sign in with Google</button>
  </div>

  <!-- Main UI -->
  <div id="mainInterface">
    <label for="frequencySelect">Frequency:</label>
    <select id="frequencySelect"><option value="alpha-1">Alpha-1</option><option value="bravo-2">Bravo-2</option><option value="charlie-3">Charlie-3</option></select>
    <div id="status"><div id="waiting">Awaiting Signal...</div><div id="incoming">!INCOMING TRAVELER!</div></div>
    <div id="log"><div id="message">No signals received yet.</div></div>
    <button id="signOutBtn">Sign Out</button>
  </div>

  <audio id="travelerSound" src="https://file.garden/aACuwggY3QmuIi9B/Incoming%20traveller.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getDatabase, ref, onChildAdded, off, remove, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAn5rsOUfkKBYhpQb3qwdUTElJP8Kg0dW0",
      authDomain: "project-gdo.firebaseapp.com",
      databaseURL: "https://project-gdo-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "project-gdo",
      storageBucket: "project-gdo.appspot.com",
      messagingSenderId: "758705115255",
      appId: "1:758705115255:web:878f5e64c164b75c507672"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // DOM elements
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authSection = document.getElementById('authSection');
    const mainInterface = document.getElementById('mainInterface');
    const frequencySelect = document.getElementById('frequencySelect');
    const waitingEl = document.getElementById('waiting');
    const incomingEl = document.getElementById('incoming');
    const messageEl = document.getElementById('message');
    const travelerSound = document.getElementById('travelerSound');

    let currentRef = null;
    let displayTimeout = null;

    // UI helper functions
    function clearMessage() {
      waitingEl.style.display = 'block';
      incomingEl.style.display = 'none';
      messageEl.textContent = 'No signals received yet.';
    }

    function showMessage(text) {
      waitingEl.style.display = 'none';
      incomingEl.style.display = 'block';
      messageEl.textContent = text;
      if (displayTimeout) clearTimeout(displayTimeout);
      displayTimeout = setTimeout(clearMessage, 10000);
    }

    // Listen to signals, auto-clean, and apply access logic
    function listenToFrequency(freq) {
      if (currentRef) { off(currentRef); currentRef = null; }

      const path = `frequencies/${freq}/signals`;
      currentRef = ref(db, path);
      onChildAdded(currentRef, async snap => {
        const data = snap.val();
        if (!data) return;

        travelerSound.volume = 1.0;
        travelerSound.currentTime = 0;
        travelerSound.play().catch(()=>{});

        const code = data.decrypted || data.code || 'UNKNOWN';
        const codeSnap = await get(ref(db, `codes/${code}`));
        let owner = 'UNKNOWN', statusText = 'Received Unknown';
        if (codeSnap.exists()) {
          const val = codeSnap.val();
          owner = val.owner || 'UNKNOWN';
          statusText = val.access === true ? 'Received and Verified'
                     : val.access === false ? 'Received INVALID'
                     : 'Received Unknown';
        }

        showMessage(`Owner: ${owner}\nCode: ${code}\nStatus: ${statusText}`);
        setTimeout(() => remove(snap.ref).catch(console.error), 15000);
      });
      clearMessage();
    }

    // Event handlers
    signInBtn.onclick = () => signInWithPopup(auth, provider).catch(console.error);
    signOutBtn.onclick = () => signOut(auth).catch(console.error);
    frequencySelect.onchange = () => listenToFrequency(frequencySelect.value);

    // Monitor authentication and toggle UI
    onAuthStateChanged(auth, user => {
      if (user) {
        authSection.style.display = 'none';
        mainInterface.style.display = 'flex';
        listenToFrequency(frequencySelect.value);
      } else {
        authSection.style.display = 'block';
        mainInterface.style.display = 'none';
        if (currentRef) { off(currentRef); currentRef = null; }
        clearMessage();
      }
    });
  </script>
</body>
</html>
