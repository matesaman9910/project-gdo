<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SGC Listener</title>
  <style>
    body {
      background-color: #000;
      color: #0f0;
      font-family: 'Courier New', Courier, monospace;
      text-align: center;
      padding: 2em;
    }
    .alert {
      background-color: #700 !important;
    }
    select, button {
      font-size: 1.2em;
      margin: 1em;
    }
    #log {
      white-space: pre-wrap;
      margin-top: 1em;
      text-align: left;
      border: 1px solid #0f0;
      padding: 1em;
      width: 80%;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h1>SGC Listener</h1>
  <p>Select Frequency:</p>
  <select id="frequencySelect">
    <option value="alpha-1">Alpha-1</option>
    <option value="bravo-2">Bravo-2</option>
    <option value="charlie-3">Charlie-3</option>
  </select>
  <div id="log">Waiting for signals...</div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAn5rsOUfkKBYhpQb3qwdUTElJP8Kg0dW0",
      authDomain: "project-gdo.firebaseapp.com",
      databaseURL: "https://project-gdo-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "project-gdo",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const freqSelect = document.getElementById('frequencySelect');
    const logDiv = document.getElementById('log');
    let currentListener = null;

    function logMessage(message, isAlert = false) {
      if (isAlert) {
        document.body.classList.add('alert');
        setTimeout(() => document.body.classList.remove('alert'), 3000);
      }
      logDiv.textContent = `!INCOMING TRAVELER!\nDecrypting...\n\n${message}\n\n` + logDiv.textContent;
    }

    function startListening(freq) {
      if (currentListener) {
        currentListener.off();
      }

      const signalRef = db.ref(`frequencies/${freq}/signals`);
      signalRef.off(); // remove old listeners
      signalRef.on('child_added', async (snapshot) => {
        const data = snapshot.val();
        const code = data.code || "UNKNOWN";
        const codeRef = db.ref(`codes/${code}`);
        const codeSnap = await codeRef.get();

        let owner = "UNKNOWN";
        let status = "Received Unknown";

        if (codeSnap.exists()) {
          const codeData = codeSnap.val();
          owner = codeData.owner || "UNKNOWN";
          if (codeData.valid === false) {
            status = "❌ Received INVALID";
            logMessage(`Owner: ${owner}\nCode: ${code}\nStatus: ${status}`, true);
          } else {
            status = "✅ Received and Verified";
            logMessage(`Owner: ${owner}\nCode: ${code}\nStatus: ${status}`);
          }
        } else {
          logMessage(`Owner: UNKNOWN\nCode: ${code}\nStatus: ❓ Received Unknown`);
        }

        // Auto-delete signal after 15s
        setTimeout(() => {
          db.ref(`frequencies/${freq}/signals/${snapshot.key}`).remove();
        }, 15000);
      });

      currentListener = signalRef;
    }

    freqSelect.addEventListener('change', () => {
      startListening(freqSelect.value);
    });

    // Start with default
    startListening(freqSelect.value);
  </script>
</body>
</html>
